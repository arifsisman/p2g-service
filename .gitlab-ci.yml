image: docker:18-git

services:
  - docker:18-dind

variables:
  DOCKER_HOST: tcp://docker:2375/
  DOCKER_DRIVER: overlay2
  SPRING_PROFILE_ACTIVE: prod
  ARTIFACT_ID_SCRIPT: "mvn org.apache.maven.plugins:maven-help-plugin:2.1.1:evaluate -Dexpression=project.artifactId | grep -Eiv 'INFO|Down|Prog'"
  POM_VERSION_SCRIPT: "mvn org.apache.maven.plugins:maven-help-plugin:2.1.1:evaluate -Dexpression=project.version | grep -Eiv 'INFO|Down|Prog'"

stages:
  - build
  - push
  - deploy

before_script:
  - docker login -u $CI_REGISTRY_USER -p $CI_JOB_TOKEN $CI_REGISTRY

after_script:
  - docker logout $CI_REGISTRY

#maven-docker-build:
#  image: twalter/maven-docker:latest
#  stage: build
#  script:
#    - mvn clean package
#    - eval ARTIFACT_ID=\$\($ARTIFACT_ID_SCRIPT\)
#    - eval POM_VERSION=\$\($POM_VERSION_SCRIPT\)
#    - IMAGE_NAME=$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
#    - ARTIFACT_NAME=$ARTIFACT_ID-$POM_VERSION-jar-with-dependencies.jar
#    - docker build -t $IMAGE_NAME --build-arg ARTIFACT_NAME=$ARTIFACT_NAME --no-cache .
#    - docker push $IMAGE_NAME
#
#push_when_tag:
#  image: twalter/maven-docker:latest
#  stage: push
#  only:
#    - tags
#  script:
#    - eval POM_VERSION=\$\($POM_VERSION_SCRIPT\)
#    - docker pull $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA
#    - docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE:$POM_VERSION
#    - docker push $CI_REGISTRY_IMAGE:$POM_VERSION

deploy_to_server:
  image: twalter/maven-docker:latest
  stage: deploy
#  only:
#    - tags
  script:
    - eval ARTIFACT_ID=\$\($ARTIFACT_ID_SCRIPT\)
    - eval POM_VERSION=\$\($POM_VERSION_SCRIPT\)
    - ssh -T arif@142.93.239.61
    - docker pull registry.gitlab.com/yazilim.vip/projects/play2gether/$ARTIFACT_ID:$POM_VERSION